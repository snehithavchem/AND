<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Letter Verification</title>
</head>
<body>
<h2>Upload Letter PDF for Verification</h2>
<input type="file" id="fileInput" accept="application/pdf">
<div id="result"></div>

<script>

// ===== PASTE YOUR PUBLIC KEY BELOW =====
const publicKeyPem = `
-----BEGIN PUBLIC KEY-----
MCowBQYDK2VwAyEAyyBexK7fEX5LcebpXC94rrs6quIniN5B7EuBNsdInLU=
-----END PUBLIC KEY-----
`;

function pemToArrayBuffer(pem) {
    const b64 = pem.replace(/-----.*-----/g, "").replace(/\s/g, "");
    const binary = atob(b64);
    const buffer = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
        buffer[i] = binary.charCodeAt(i);
    }
    return buffer;
}

async function verifySignature(data, signatureB64) {

    const keyBuffer = pemToArrayBuffer(publicKeyPem);

    const publicKey = await crypto.subtle.importKey(
        "spki",
        keyBuffer,
        { name: "Ed25519" },
        false,
        ["verify"]
    );

    const signature = Uint8Array.from(atob(signatureB64), c => c.charCodeAt(0));
    const encoder = new TextEncoder();
    const dataBytes = encoder.encode(JSON.stringify(data));

    return await crypto.subtle.verify(
        "Ed25519",
        publicKey,
        signature,
        dataBytes
    );
}

async function sha256(file) {
    const buffer = await file.arrayBuffer();
    const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

async function main() {

    const hash = window.location.hash;
    if (!hash.includes("payload=")) {
        document.getElementById("result").innerText = "Invalid QR.";
        return;
    }

    const payloadB64 = hash.split("payload=")[1];
    const payload = JSON.parse(atob(payloadB64));

    const fileInput = document.getElementById("fileInput");

    fileInput.addEventListener("change", async () => {

        const file = fileInput.files[0];
        const computedHash = await sha256(file);

        if (computedHash !== payload.data.pdf_hash) {
            document.getElementById("result").innerHTML =
                "<h3 style='color:red;'>✘ PDF CONTENT MODIFIED</h3>";
            return;
        }

        const valid = await verifySignature(payload.data, payload.sig);

        if (valid) {
            document.getElementById("result").innerHTML =
                "<h3 style='color:green;'>✔ AUTHENTIC LETTER</h3>";
        } else {
            document.getElementById("result").innerHTML =
                "<h3 style='color:red;'>✘ INVALID SIGNATURE</h3>";
        }

    });
}

main();
</script>
</body>
</html>
