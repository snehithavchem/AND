<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Letter Verification</title>
</head>
<body>
<h2>Upload Letter PDF for Verification</h2>
<input type="file" id="fileInput" accept="application/pdf">
<div id="result"></div>

<script>

const publicKeyPem = `
-----BEGIN PUBLIC KEY-----
MCowBQYDK2VwAyEAyyBexK7fEX5LcebpXC94rrs6quIniN5B7EuBNsdInLU=
-----END PUBLIC KEY-----
`;

function pemToArrayBuffer(pem) {
    const b64 = pem.replace(/-----.*-----/g, "").replace(/\s/g, "");
    const binary = atob(b64);
    const buffer = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
        buffer[i] = binary.charCodeAt(i);
    }
    return buffer;
}

// Canonical JSON stringify (sorted keys)
function canonicalStringify(obj) {
    return JSON.stringify(
        Object.keys(obj).sort().reduce((acc, key) => {
            acc[key] = obj[key];
            return acc;
        }, {})
    );
}

async function verifySignature(data, signatureB64) {

    const keyBuffer = pemToArrayBuffer(publicKeyPem);

    const publicKey = await crypto.subtle.importKey(
        "spki",
        keyBuffer,
        { name: "Ed25519" },
        false,
        ["verify"]
    );

    const signature = Uint8Array.from(atob(signatureB64), c => c.charCodeAt(0));

    const encoder = new TextEncoder();
    const dataBytes = encoder.encode(canonicalStringify(data));

    return await crypto.subtle.verify(
        "Ed25519",
        publicKey,
        signature,
        dataBytes
    );
}

async function main() {

    const hash = window.location.hash;
    if (!hash.includes("payload=")) {
        document.body.innerHTML = "<h3>Invalid QR</h3>";
        return;
    }

    const payloadB64 = hash.split("payload=")[1];
    const payload = JSON.parse(atob(payloadB64));

    const valid = await verifySignature(payload.data, payload.sig);

    if (valid) {
        document.body.innerHTML = `
            <h2 style="color:green;">✔ AUTHENTIC LETTER</h2>
            <pre>${JSON.stringify(payload.data, null, 2)}</pre>
        `;
    } else {
        document.body.innerHTML = `
            <h2 style="color:red;">✘ INVALID SIGNATURE</h2>
        `;
    }
}

main();
</script>
</body>
</html>
